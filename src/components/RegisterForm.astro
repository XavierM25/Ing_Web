---
import '../layouts/styles/global.css';
---

<form class="space-y-5" id="registrationForm">
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label
        for="firstName"
        class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2"
      >
        <svg
          class="w-3.5 h-3.5"
          data-testid="geist-icon"
          height="16"
          stroke-linejoin="round"
          viewBox="0 0 16 16"
          width="16"
          style="color:currentcolor"
          ><path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M7.75 0A3.25 3.25 0 0 0 4.5 3.25v.5A3.25 3.25 0 0 0 7.75 7h.5a3.25 3.25 0 0 0 3.25-3.25v-.5A3.25 3.25 0 0 0 8.25 0zM6 3.25c0-.966.784-1.75 1.75-1.75h.5c.966 0 1.75.784 1.75 1.75v.5A1.75 1.75 0 0 1 8.25 5.5h-.5A1.75 1.75 0 0 1 6 3.75zM2.5 14.5v-1.33a4.84 4.84 0 0 1 4.33-2.67h2.34a4.84 4.84 0 0 1 4.33 2.67v1.33zM6.83 9a6.34 6.34 0 0 0-5.761 3.686l-.069.15V16h14v-3.165l-.069-.15A6.34 6.34 0 0 0 9.171 9z"
            fill="currentColor"></path></svg
        >
        Nombres
      </label>
      <input
        type="text"
        id="firstName"
        name="firstName"
        required
        class="font-inter text-sm rounded-xl w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
        placeholder="Ingresa tus nombres"
      />
      <p id="firstNameError" class="mt-1 text-sm text-red-500 hidden"></p>
    </div>

    <div>
      <label
        for="lastName"
        class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2"
      >
        <svg
          class="w-3.5 h-3.5"
          data-testid="geist-icon"
          height="16"
          stroke-linejoin="round"
          viewBox="0 0 16 16"
          width="16"
          style="color:currentcolor"
          ><path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M2.5 3.25A3.25 3.25 0 0 1 5.75 0h.5A3.25 3.25 0 0 1 9.5 3.25v.5A3.25 3.25 0 0 1 6.25 7h-.5A3.25 3.25 0 0 1 2.5 3.75zM5.75 1.5A1.75 1.75 0 0 0 4 3.25v.5c0 .966.784 1.75 1.75 1.75h.5A1.75 1.75 0 0 0 8 3.75v-.5A1.75 1.75 0 0 0 6.25 1.5zm-4.25 13v-1.33a4.84 4.84 0 0 1 4.33-2.67h.34a4.84 4.84 0 0 1 4.33 2.67v1.33zM5.83 9a6.34 6.34 0 0 0-5.761 3.686l-.069.15V16h12v-3.165l-.069-.15A6.34 6.34 0 0 0 6.171 9zm10.101 3.686a6.34 6.34 0 0 0-2.587-2.835l-.75 1.298a4.84 4.84 0 0 1 1.906 2.022V14.5h-1V16H16v-3.165zM11.25 0h-.75v1.5h.75c.966 0 1.75.784 1.75 1.75v.5a1.75 1.75 0 0 1-1.75 1.75h-.75V7h.75a3.25 3.25 0 0 0 3.25-3.25v-.5A3.25 3.25 0 0 0 11.25 0"
            fill="currentColor"></path></svg
        >
        Apellidos
      </label>
      <input
        type="text"
        id="lastName"
        name="lastName"
        required
        class="font-inter text-sm rounded-xl w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
        placeholder="Ingresa tus apellidos"
      />
      <p id="lastNameError" class="mt-1 text-sm text-red-500 hidden"></p>
    </div>
  </div>

  <div>
    <label
      for="email"
      class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2 font-onest"
    >
      <svg
        class="w-3.5 h-3.5"
        data-testid="geist-icon"
        height="16"
        stroke-linejoin="round"
        viewBox="0 0 16 16"
        width="16"
        style="color:currentcolor"
        ><path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M8 0C3.578 0 0 3.617 0 8.03 0 12.412 3.55 16 7.938 16a7.94 7.94 0 0 0 4.208-1.207l.252-.157-.796-1.272-.251.157a6.44 6.44 0 0 1-3.413.979C4.387 14.5 1.5 11.59 1.5 8.03 1.5 4.438 4.414 1.5 8 1.5A6.5 6.5 0 0 1 14.5 8v.607c0 .77-.624 1.393-1.393 1.393-.887 0-1.607-.72-1.607-1.607V4.5H10v.627a3.5 3.5 0 1 0 .647 5.163 3.1 3.1 0 0 0 2.46 1.21A2.893 2.893 0 0 0 16 8.607V8a8 8 0 0 0-8-8m2 8a2 2 0 1 0-4 0 2 2 0 0 0 4 0"
          fill="currentColor"></path></svg
      >
      Correo
    </label>
    <input
      type="email"
      id="registerEmail"
      name="email"
      required
      class="font-inter text-sm rounded-xl w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
      placeholder="Ingresa tu correo"
    />
    <p id="emailError" class="mt-1 text-sm text-red-500 hidden"></p>
  </div>

  <div>
    <label
      for="password"
      class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2 font-onest"
    >
      <svg
        class="w-3.5 h-3.5"
        data-testid="geist-icon"
        height="16"
        stroke-linejoin="round"
        viewBox="0 0 16 16"
        width="16"
        style="color:currentcolor"
        ><path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M10 4.5V6H6V4.5a2 2 0 1 1 4 0M4.5 6V4.5a3.5 3.5 0 1 1 7 0V6H14v6.5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 12.5V6zm7 1.5h-8v5a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1v-5z"
          fill="currentColor"></path></svg
      >
      Contraseña
    </label>
    <div class="relative">
      <input
        type="password"
        id="registerPassword"
        name="password"
        required
        class="font-inter text-sm w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
        placeholder="••••••••"
      />
      <button
        type="button"
        id="toggleRegisterPassword"
        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-600 transition"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </button>
    </div>
  </div>

  <div>
    <label
      for="confirmPassword"
      class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2"
    >
      <svg
        class="w-3.5 h-3.5"
        data-testid="geist-icon"
        height="16"
        stroke-linejoin="round"
        viewBox="0 0 16 16"
        width="16"
        style="color:currentcolor"
        ><path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M10 4.5V6H6V4.5a2 2 0 1 1 4 0M4.5 6V4.5a3.5 3.5 0 1 1 7 0V6H14v6.5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 12.5V6zm7 1.5h-8v5a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1v-5z"
          fill="currentColor"></path></svg
      >
      Repetir contraseña
    </label>
    <div class="relative">
      <input
        type="password"
        id="confirmPassword"
        name="confirmPassword"
        required
        class="font-inter text-sm rounded-xl w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
        placeholder="••••••••"
      />
      <button
        type="button"
        id="toggleConfirmPassword"
        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </button>
    </div>
    <p id="errorMessage" class="text-red-500 hidden">
      Las contraseñas no coinciden.
    </p>
    <p id="confirmPasswordError" class="mt-1 text-sm text-red-500 hidden"></p>
  </div>

  <div>
    <label
      for="birthDate"
      class="text-base font-medium text-[#222] font-onest mb-1 flex items-center gap-2"
    >
      <svg
        class="w-3.5 h-3.5"
        data-testid="geist-icon"
        height="16"
        stroke-linejoin="round"
        viewBox="0 0 16 16"
        width="16"
        style="color:currentcolor"
        ><path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M5.5.5V2h5V.5H12V2h3.5v11.5A2.5 2.5 0 0 1 13 16H3a2.5 2.5 0 0 1-2.5-2.5V2H4V.5zM2 3.5h12V6H2zm0 4v6a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-6z"
          fill="currentColor"></path></svg
      >
      Fecha de nacimiento
    </label>
    <input
      type="date"
      id="birthDate"
      name="birthDate"
      required
      class="font-inter text-sm rounded-xl w-full px-4 py-3 border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-gray-700"
    />
    <p id="dateError" class="mt-1 text-sm text-red-500 hidden">
      Please enter a valid date
    </p>
  </div>

  <div class="flex items-center">
    <input
      type="checkbox"
      id="terms"
      name="terms"
      required
      class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
    />
    <label for="terms" class="font-inter ml-2 text-sm text-gray-700">
      Acepto los <a href="#" class="text-blue-600 hover:text-blue-500"
        >Términos y Condiciones</a
      >
    </label>
  </div>

  <button
    type="submit"
    class="font-poppins w-full bg-[#222] text-white rounded-lg px-4 py-3 font-medium hover:bg-[#3d3d3d] focus:outline-none focus:ring-2 focus:ring-gray-700 focus:ring-offset-2 transition duration-300"
  >
    Crear cuenta
  </button>

  <p class="font-inter text-center text-sm text-gray-500">
    ¿Ya tienes una cuenta?
    <a
      href="/login"
      class="font-inter font-medium text-blue-600 hover:text-blue-500"
    >
      Inicia sesión
    </a>
  </p>
</form>

<script>
  const dateInput = document.getElementById('birthDate') as HTMLInputElement;
  const dateError = document.getElementById('dateError');

  function isValidDate(date: Date): boolean {
    return date instanceof Date && !isNaN(date.getTime());
  }

  function updateMaxDate() {
    const today = new Date();
    const maxDate = new Date(
      today.getFullYear() - 13,
      today.getMonth(),
      today.getDate(),
    );
    dateInput.setAttribute('max', maxDate.toISOString().split('T')[0]);

    // Set min date to 120 years ago
    const minDate = new Date(
      today.getFullYear() - 120,
      today.getMonth(),
      today.getDate(),
    );
    dateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
  }

  function validateDate() {
    const selectedDate = new Date(dateInput.value);
    const today = new Date();
    const maxDate = new Date(
      today.getFullYear() - 3,
      today.getMonth(),
      today.getDate(),
    );
    const minDate = new Date(
      today.getFullYear() - 120,
      today.getMonth(),
      today.getDate(),
    );

    if (
      !isValidDate(selectedDate) ||
      selectedDate > maxDate ||
      selectedDate < minDate
    ) {
      dateInput.classList.add('border-red-500');
      dateInput.classList.remove('border-gray-300');
      if (dateError) {
        dateError.classList.remove('hidden');
        dateError.textContent =
          selectedDate > maxDate
            ? 'Tienes que ser mayor de 3 años para registrarte'
            : 'Por favor ingresa una fecha válida';
      }
      return false;
    } else {
      dateInput.classList.remove('border-red-500');
      dateInput.classList.add('border-gray-300');
      if (dateError) {
        dateError.classList.add('hidden');
      }
      return true;
    }
  }

  updateMaxDate();
  dateInput?.addEventListener('change', validateDate);

  document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.querySelector('#registerPassword');
    const confirmPasswordInput = document.querySelector('#confirmPassword');
    const togglePassword = document.querySelector('#toggleRegisterPassword');
    const toggleConfirmPassword = document.querySelector(
      '#toggleConfirmPassword',
    );
    const submitButton = document.querySelector(
      '#registrationForm button[type="submit"]',
    );
    const errorMessage = document.querySelector('#errorMessage');

    // Función para verificar si las contraseñas coinciden
    const checkPasswordsMatch = () => {
      if (
        passwordInput &&
        confirmPasswordInput &&
        (passwordInput as HTMLInputElement).value !==
          (confirmPasswordInput as HTMLInputElement).value
      ) {
        errorMessage?.classList.remove('hidden');
        submitButton?.setAttribute('disabled', 'true');
      } else {
        errorMessage?.classList.add('hidden');
        submitButton?.removeAttribute('disabled');
      }
    };

    passwordInput?.addEventListener('input', checkPasswordsMatch);
    confirmPasswordInput?.addEventListener('input', checkPasswordsMatch);

    // Lógica para mostrar/ocultar contraseña y cambiar SVG en password
    togglePassword?.addEventListener('click', () => {
      const type =
        passwordInput?.getAttribute('type') === 'password'
          ? 'text'
          : 'password';
      passwordInput?.setAttribute('type', type);

      const svg = togglePassword.querySelector('svg');
      if (type === 'password') {
        svg!.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    `;
      } else {
        svg!.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
    `;
      }
    });

    // Lógica para mostrar/ocultar contraseña y cambiar SVG en confirmPassword
    toggleConfirmPassword?.addEventListener('click', () => {
      if (confirmPasswordInput) {
        const type =
          confirmPasswordInput.getAttribute('type') === 'password'
            ? 'text'
            : 'password';
        confirmPasswordInput.setAttribute('type', type);

        const svg = toggleConfirmPassword.querySelector('svg');
        if (svg) {
          if (type === 'password') {
            svg.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        `;
          } else {
            svg.innerHTML = `
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
        `;
          }
        }
      }
    });
  });

  //Registro a base de datos
  const registrationForm = document.getElementById(
    'registrationForm',
  ) as HTMLFormElement;
  registrationForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      nombres: (document.getElementById('firstName') as HTMLInputElement).value,
      apellidos: (document.getElementById('lastName') as HTMLInputElement)
        .value,
      email: (document.getElementById('registerEmail') as HTMLInputElement)
        .value,
      password: (
        document.getElementById('registerPassword') as HTMLInputElement
      ).value,
      fechaNacimiento: (
        document.getElementById('birthDate') as HTMLInputElement
      ).value,
    };

    try {
      const response = await fetch('http://localhost:5000/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData),
      });

      const data = await response.json();

      if (response.ok) {
        // Registro exitoso
        window.location.href = '/auth';
      } else {
        // Manejo de errores
        console.error(data.message || 'Error al registrar usuario');
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>
